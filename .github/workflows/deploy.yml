name: deploy stacks.ethui.dev

on:
  push:
    branches:
      - main
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    environment: production

    steps:
    - uses: actions/checkout@v3

    - uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.18.3'
        otp-version: 'OTP-27'

    - run: mix deps.get
    - run: mix compile
    - run: mix release

    - run: ssh-keyscan stacks.ethui.dev
    - run: ssh-keyscan ${{ env.DIGITALOCEAN_HOST }}
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.DIGITALOCEAN_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan ${{ env.DIGITALOCEAN_HOST }} >> ~/.ssh/known_hosts

    - name: Upload release via rsync
      run: |
        rsync \
          -az \
          --delete \
          _build/prod/rel/ethui/ \
          ${{ env.SSH_HOST }}:$DEPLOY_PATH

    - name: Restart app
      run: |
        ssh ${{ env.SSH_HOST }} 'cd ${{ env.DEPLOY_PATH }} && echo "asd" && touch asd'

